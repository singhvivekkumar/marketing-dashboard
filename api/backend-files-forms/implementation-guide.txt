# Complete Backend Implementation Guide

## Step-by-Step Setup Instructions

### Step 1: Create Project Directory

```bash
mkdir tender-backend
cd tender-backend
npm init -y
```

### Step 2: Install Dependencies

```bash
npm install express pg dotenv cors helmet morgan uuid
npm install --save-dev nodemon
```

### Step 3: Create Folder Structure

```bash
mkdir config
mkdir controllers
mkdir models
mkdir routes
mkdir middleware
```

### Step 4: Create Files in Order

1. **config/database.js** - Database connection pool
2. **middleware/errorHandler.js** - Global error handling
3. **middleware/validation.js** - Input validation
4. **models/LostDomesticLead.js** - Data model (repeat for all 7 forms)
5. **controllers/lostDomesticLeadsController.js** - Request handlers (repeat for all 7)
6. **routes/lostDomesticLeads.js** - Route definitions (repeat for all 7)
7. **server.js** - Main application file
8. **.env** - Environment variables
9. **package.json** - Dependencies

### Step 5: PostgreSQL Setup

```bash
# Connect to PostgreSQL
psql -U postgres

# Create database
CREATE DATABASE tender_management;

# Exit
\q

# Load schema
psql -U postgres -d tender_management -f database-schema.sql
```

### Step 6: Create Controllers for All Forms

Follow the same pattern as `lostDomesticLeadsController.js` for:
- domesticOrderController.js
- budgetaryQuotationController.js
- leadSubmittedController.js
- domesticLeadsV2Controller.js
- exportLeadsController.js
- crmLeadsController.js

### Step 7: Create Models for All Forms

Follow the same pattern as `LostDomesticLead.js` model for:
- DomesticOrder.js
- BudgetaryQuotation.js
- LeadSubmitted.js
- DomesticLeadV2.js
- ExportLead.js
- CRMLead.js

Each model implements:
- `create(data)` - Insert new record
- `getAll(limit, offset)` - Get paginated records
- `getById(id)` - Get single record
- `update(id, data)` - Update record
- `delete(id)` - Delete record
- `getCount()` - Get total count

### Step 8: Create Routes for All Forms

Create route files that follow RESTful pattern:
- `/api/lost-domestic-leads`
- `/api/domestic-order`
- `/api/budgetary-quotation`
- `/api/lead-submitted`
- `/api/domestic-leads-v2`
- `/api/export-leads`
- `/api/crm-leads`

Each with POST, GET, GET/:id, PUT/:id, DELETE/:id

### Step 9: Update server.js

Register all routes in the main Express app

### Step 10: Test Server

```bash
npm run dev
```

Visit http://localhost:5000

## Testing the API

### Using cURL

```bash
# Create a lead
curl -X POST http://localhost:5000/api/lost-domestic-leads \
  -H "Content-Type: application/json" \
  -d '{
    "serialNumber": "TEST-001",
    "tenderName": "Test Tender",
    "customer": "Test Customer",
    "tenderType": "Open"
  }'

# Get all leads
curl http://localhost:5000/api/lost-domestic-leads

# Get single lead
curl http://localhost:5000/api/lost-domestic-leads/{id}

# Update lead
curl -X PUT http://localhost:5000/api/lost-domestic-leads/{id} \
  -H "Content-Type: application/json" \
  -d '{"tenderName": "Updated Name"}'

# Delete lead
curl -X DELETE http://localhost:5000/api/lost-domestic-leads/{id}
```

### Using Postman

1. Create new collection "Tender Management"
2. Create folders for each form
3. Add requests for each endpoint
4. Use environment variables for base URL
5. Save and share collection

## Connecting Frontend Forms to Backend

### From React Form to API

```javascript
// Example: Lost Domestic Leads Form submission
const onSubmit = async (data) => {
  try {
    const response = await fetch('http://localhost:5000/api/lost-domestic-leads', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });
    
    const result = await response.json();
    
    if (result.success) {
      console.log('Lead created:', result.data);
      setSuccessMessage('Lead submitted successfully');
    } else {
      console.error('Error:', result.message);
      setErrorMessage(result.message);
    }
  } catch (error) {
    console.error('Request failed:', error);
    setErrorMessage('Failed to submit lead');
  }
};
```

## Common Issues & Solutions

### Issue 1: Database Connection Error
**Solution:**
```bash
# Check PostgreSQL is running
psql -U postgres -c "SELECT version();"

# Check database exists
psql -U postgres -l | grep tender_management

# Verify .env credentials
cat .env
```

### Issue 2: Port Already in Use
**Solution:**
```bash
# Change PORT in .env or
lsof -i :5000
kill -9 <PID>
```

### Issue 3: CORS Error from Frontend
**Solution:** Update server.js CORS configuration
```javascript
app.use(cors({
  origin: 'http://localhost:3000', // Your frontend URL
  credentials: true
}));
```

### Issue 4: Table Does Not Exist
**Solution:**
```bash
# Re-run schema
psql -U postgres -d tender_management -f database-schema.sql

# Or manually create table
psql -U postgres -d tender_management
```

## Adding More Models/Controllers/Routes

### Template for New Form

1. **Model (models/NewForm.js)**
```javascript
class NewForm {
  static async create(data) {
    // Implementation
  }
  static async getAll() { }
  static async getById(id) { }
  static async update(id, data) { }
  static async delete(id) { }
  static async getCount() { }
}
module.exports = NewForm;
```

2. **Controller (controllers/newFormController.js)**
```javascript
const NewForm = require('../models/NewForm');

exports.create = async (req, res, next) => {
  // Implementation - follow pattern from lostDomesticLeadsController
};

exports.getAll = async (req, res, next) => { };
exports.getById = async (req, res, next) => { };
exports.update = async (req, res, next) => { };
exports.delete = async (req, res, next) => { };
```

3. **Routes (routes/newForm.js)**
```javascript
const express = require('express');
const controller = require('../controllers/newFormController');
const router = express.Router();

router.post('/', controller.create);
router.get('/', controller.getAll);
router.get('/:id', controller.getById);
router.put('/:id', controller.update);
router.delete('/:id', controller.delete);

module.exports = router;
```

4. **Update server.js**
```javascript
const newFormRoutes = require('./routes/newForm');
app.use('/api/new-form', newFormRoutes);
```

## Performance Optimization

### Add Indexes
Already included in database-schema.sql

### Enable Connection Pooling
Already configured in database.js

### Add Caching (Optional)
```javascript
// Install: npm install redis
const redis = require('redis');
const client = redis.createClient();
```

### Pagination
Always use pagination for GET all endpoints

## Security Checklist

- [ ] Validate all inputs
- [ ] Sanitize user data
- [ ] Use environment variables for secrets
- [ ] Implement rate limiting
- [ ] Use HTTPS in production
- [ ] Add authentication/authorization
- [ ] Log security events
- [ ] Regular backups
- [ ] Monitor database queries
- [ ] Keep dependencies updated

## Deployment to Production

### Using Heroku

```bash
# Install Heroku CLI
npm install -g heroku

# Login
heroku login

# Create app
heroku create tender-api

# Set environment variables
heroku config:set DB_HOST=your_db_host
heroku config:set DB_PASSWORD=your_db_password

# Deploy
git push heroku main
```

### Using AWS EC2

1. Launch EC2 instance
2. Install Node.js and PostgreSQL
3. Clone repository
4. Install dependencies
5. Configure environment
6. Start with PM2
7. Set up Nginx reverse proxy

### Using Docker

```dockerfile
FROM node:14
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
EXPOSE 5000
CMD ["npm", "start"]
```

```bash
docker build -t tender-api .
docker run -d -p 5000:5000 tender-api
```

## Monitoring & Logging

### Install Monitoring Tools
```bash
npm install winston
npm install pm2-logrotate
```

### Check Server Logs
```bash
pm2 logs tender-api
```

### Monitor Database
```sql
-- Check active connections
SELECT * FROM pg_stat_activity;

-- Check table sizes
SELECT schemaname, tablename, pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) AS size
FROM pg_tables
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;
```

## Support Resources

- Express.js: https://expressjs.com/
- PostgreSQL: https://www.postgresql.org/docs/
- Node.js: https://nodejs.org/docs/
- pg npm package: https://node-postgres.com/
- REST API Best Practices: https://restfulapi.net/

## Next Steps

1. ✅ Setup backend infrastructure
2. ✅ Create database and tables
3. ✅ Implement all controllers and models
4. ✅ Test all endpoints
5. ⏭️ Add authentication (JWT)
6. ⏭️ Add role-based access control
7. ⏭️ Implement file upload for attachments
8. ⏭️ Add email notifications
9. ⏭️ Create dashboard API endpoints
10. ⏭️ Deploy to production
