// models/LostDomesticLead.js - Model for Lost Domestic Leads

const pool = require('../config/database');
const { v4: uuidv4 } = require('uuid');

class LostDomesticLead {
  static async create(data) {
    const id = uuidv4();
    const query = `
      INSERT INTO lost_domestic_leads (
        id, serial_number, tender_name, customer, tender_type, 
        type_bid, value_without_gst, value_with_gst, reason_losing, 
        year, partner, competitors, technical_scores, quoted_prices, 
        submitted_at
      ) VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15)
      RETURNING *;
    `;

    const values = [
      id,
      data.serialNumber,
      data.tenderName,
      data.customer,
      data.tenderType,
      data.typeBid,
      data.valueWithoutGST,
      data.valueWithGST,
      data.reasonLosing,
      data.year,
      data.partner,
      JSON.stringify(data.competitors || []),
      JSON.stringify(data.technicalScores || []),
      JSON.stringify(data.quotedPrices || []),
      new Date()
    ];

    const result = await pool.query(query, values);
    return result.rows[0];
  }

  static async getAll(limit = 100, offset = 0) {
    const query = `
      SELECT * FROM lost_domestic_leads 
      ORDER BY submitted_at DESC 
      LIMIT $1 OFFSET $2;
    `;
    const result = await pool.query(query, [limit, offset]);
    return result.rows;
  }

  static async getById(id) {
    const query = 'SELECT * FROM lost_domestic_leads WHERE id = $1;';
    const result = await pool.query(query, [id]);
    return result.rows[0];
  }

  static async update(id, data) {
    const updates = [];
    const values = [];
    let paramCount = 1;

    for (const [key, value] of Object.entries(data)) {
      let dbKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
      if (key === 'competitors' || key === 'technicalScores' || key === 'quotedPrices') {
        updates.push(`${dbKey} = $${paramCount}`);
        values.push(JSON.stringify(value));
      } else {
        updates.push(`${dbKey} = $${paramCount}`);
        values.push(value);
      }
      paramCount++;
    }

    updates.push(`updated_at = $${paramCount}`);
    values.push(new Date());
    paramCount++;

    values.push(id);

    const query = `
      UPDATE lost_domestic_leads 
      SET ${updates.join(', ')} 
      WHERE id = $${paramCount}
      RETURNING *;
    `;

    const result = await pool.query(query, values);
    return result.rows[0];
  }

  static async delete(id) {
    const query = 'DELETE FROM lost_domestic_leads WHERE id = $1 RETURNING *;';
    const result = await pool.query(query, [id]);
    return result.rows[0];
  }

  static async getCount() {
    const query = 'SELECT COUNT(*) as count FROM lost_domestic_leads;';
    const result = await pool.query(query);
    return parseInt(result.rows[0].count);
  }
}

module.exports = LostDomesticLead;
